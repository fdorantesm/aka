name: Publish to npm

on:
    workflow_dispatch:
        inputs:
            npm_tag:
                description: "npm tag (latest, beta, next, etc.)"
                required: false
                default: "latest"
                type: choice
                options:
                    - latest
                    - beta
                    - next
                    - canary
    workflow_call:
        inputs:
            npm_tag:
                description: "npm tag (latest, beta, next, etc.)"
                required: false
                default: "latest"
                type: string

jobs:
    publish:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            id-token: write
        steps:
            - name: Checkout code
              uses: actions/checkout@v3
              with:
                  fetch-depth: 0

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  registry-url: "https://registry.npmjs.org"
                  always-auth: true

            - name: Verify package.json exists
              run: |
                  if [ ! -f package.json ]; then
                    echo "Error: package.json not found"
                    exit 1
                  fi

            - name: Get package version
              id: package_version
              run: |
                  VERSION=$(node -p "require('./package.json').version")
                  echo "VERSION=$VERSION" >> $GITHUB_ENV
                  echo "Publishing version: $VERSION"

            - name: Check authentication method
              id: auth_method
              run: |
                  if [ -n "${{ secrets.NPM_TOKEN }}" ]; then
                    echo "method=token" >> $GITHUB_OUTPUT
                    echo "Using NPM_TOKEN for authentication"
                  else
                    echo "method=oidc" >> $GITHUB_OUTPUT
                    echo "Using OIDC (provenance) for authentication"
                  fi

            - name: Publish to npm (with token)
              if: steps.auth_method.outputs.method == 'token'
              run: npm publish --access public --tag ${{ inputs.npm_tag }}
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

            - name: Publish to npm (with OIDC)
              if: steps.auth_method.outputs.method == 'oidc'
              run: npm publish --access public --tag ${{ inputs.npm_tag }} --provenance
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

            - name: Create deployment summary
              run: |
                  echo "## ðŸ“¦ npm Package Published" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "- **Package:** aka-cli" >> $GITHUB_STEP_SUMMARY
                  echo "- **Version:** ${{ env.VERSION }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **Tag:** ${{ inputs.npm_tag }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **Auth Method:** ${{ steps.auth_method.outputs.method }}" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "Install with:" >> $GITHUB_STEP_SUMMARY
                  echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
                  echo "npm install -g aka-cli" >> $GITHUB_STEP_SUMMARY
                  echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
